<!DOCTYPE html>  <html> <head>   <title>war.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               war.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">vendors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;moz&#39;</span><span class="p">,</span> <span class="s1">&#39;webkit&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">vendors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">;</span> <span class="o">++</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;RequestAnimationFrame&#39;</span><span class="p">];</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span>
          <span class="nb">window</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelAnimationFrame&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="nb">window</span><span class="p">[</span><span class="nx">vendors</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;CancelRequestAnimationFrame&#39;</span><span class="p">];</span>
    <span class="p">}</span>
 </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Temporarily disabling the realRequestAnimationFrame
because it wasn't giving good performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/*if (!window.requestAnimationFrame)*/</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">currTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">timeToCall</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span><span class="nx">currTime</span> <span class="o">-</span> <span class="nx">lastTime</span><span class="p">));</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">);</span> <span class="p">},</span>
              <span class="nx">timeToCall</span><span class="p">);</span>
            <span class="nx">lastTime</span> <span class="o">=</span> <span class="nx">currTime</span> <span class="o">+</span> <span class="nx">timeToCall</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">};</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">)</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">};</span>
<span class="p">}());</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>From http://baagoe.com/en/RandomMusings/javascript/
Johannes Baagøe <a href="&#x6D;&#97;&#x69;&#108;&#x74;&#x6F;:&#x62;&#97;&#x61;&#x67;&#111;&#101;&#64;&#98;&#x61;&#97;g&#x6F;&#x65;&#46;c&#x6F;&#x6D;">&#x62;&#97;&#x61;&#x67;&#111;&#101;&#64;&#98;&#x61;&#97;g&#x6F;&#x65;&#46;c&#x6F;&#x6D;</a>, 2010</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Mash</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mh">0xefc8249d</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">mash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">n</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mf">0.02519603282416938</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">*=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="nx">n</span> <span class="o">+=</span> <span class="nx">h</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span> <span class="c1">// 2^32</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.3283064365386963</span><span class="nx">e</span><span class="o">-</span><span class="mi">10</span><span class="p">;</span> <span class="c1">// 2^-32</span>
  <span class="p">};</span>

  <span class="nx">mash</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;Mash 0.9&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">mash</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>From http://baagoe.com/en/RandomMusings/javascript/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Alea</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Johannes Baagøe <a href="&#x6D;&#97;&#x69;&#108;&#116;&#111;:&#x62;&#x61;&#97;g&#111;&#101;&#64;&#x62;a&#97;&#x67;&#x6F;&#101;.&#x63;&#x6F;&#109;">&#x62;&#x61;&#97;g&#111;&#101;&#64;&#x62;a&#97;&#x67;&#x6F;&#101;.&#x63;&#x6F;&#109;</a>, 2010</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">s0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">s2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()];</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">mash</span> <span class="o">=</span> <span class="nx">Mash</span><span class="p">();</span>
    <span class="nx">s0</span> <span class="o">=</span> <span class="nx">mash</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="nx">s1</span> <span class="o">=</span> <span class="nx">mash</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="nx">s2</span> <span class="o">=</span> <span class="nx">mash</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s0</span> <span class="o">-=</span> <span class="nx">mash</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s0</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">s1</span> <span class="o">-=</span> <span class="nx">mash</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s1</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">s2</span> <span class="o">-=</span> <span class="nx">mash</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s2</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">mash</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">random</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="mi">2091639</span> <span class="o">*</span> <span class="nx">s0</span> <span class="o">+</span> <span class="nx">c</span> <span class="o">*</span> <span class="mf">2.3283064365386963</span><span class="nx">e</span><span class="o">-</span><span class="mi">10</span><span class="p">;</span> <span class="c1">// 2^-32</span>
      <span class="nx">s0</span> <span class="o">=</span> <span class="nx">s1</span><span class="p">;</span>
      <span class="nx">s1</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">;</span>
      <span class="nx">s2</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">-</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">s2</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nx">random</span><span class="p">.</span><span class="nx">uint32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span> <span class="c1">// 2^32</span>
    <span class="p">};</span>
    <span class="nx">random</span><span class="p">.</span><span class="nx">fract53</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">random</span><span class="p">()</span> <span class="o">+</span>
        <span class="p">(</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mh">0x200000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1102230246251565</span><span class="nx">e</span><span class="o">-</span><span class="mi">16</span><span class="p">;</span> <span class="c1">// 2^-53</span>
    <span class="p">};</span>
    <span class="nx">random</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;Alea 0.9&#39;</span><span class="p">;</span>
    <span class="nx">random</span><span class="p">.</span><span class="nx">args</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">random</span><span class="p">;</span>

  <span class="p">}</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Set up namespace</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Use "self" only where "this" is unavailable
due to a scope change</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">this</span><span class="p">.</span><span class="nx">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Alea</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">());</span>

<span class="k">this</span><span class="p">.</span><span class="nx">recordTiming</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="k">this</span><span class="p">.</span><span class="nx">drawFlockMesh</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">drawRanges</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">drawVectors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">drawHealthIndicators</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="k">this</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">||</span> <span class="mi">1800</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">viewportHeight</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">||</span> <span class="mi">800</span><span class="p">;</span>

<span class="k">this</span><span class="p">.</span><span class="nx">killStats</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">this</span><span class="p">.</span><span class="nx">entityCounts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">Entity</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">Proj</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

<span class="kd">var</span> <span class="nx">Entity</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Entity</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Instance properties.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span>
    <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="nx">radius</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>

        <span class="nx">heading</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>

        <span class="nx">pos</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="nx">vel</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="nx">accel</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="nx">jerk</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>

        <span class="nx">playerControlled</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

        <span class="nx">neighborhoodRadius</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>

        <span class="nx">maxVel</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">maxAccel</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nx">maxJerk</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">jerkMag</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">frictionFactor</span><span class="o">:</span> <span class="mf">0.07</span><span class="p">,</span>

        <span class="nx">avoidanceRange</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">avoidanceStrength</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="nx">edgeAvoidanceRange</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="nx">edgeAvoidanceStrength</span><span class="o">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="nx">cohesionRange</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">cohesionStrength</span><span class="o">:</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="nx">steerDampingDistance</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">alignmentRange</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">alignmentStrength</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">separationRange</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="nx">separationStrength</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>

        <span class="nx">doCollisionChecks</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

        <span class="nx">autoFire</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">firingRate</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// Projectiles per second.</span>
        <span class="nx">lastFired</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">accuracy</span><span class="o">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="nx">muzzleVel</span><span class="o">:</span> <span class="mf">4.5</span><span class="p">,</span>
        <span class="nx">weaponRange</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>

        <span class="nx">edgeMode</span><span class="o">:</span> <span class="s2">&quot;constrain&quot;</span><span class="p">,</span>

        <span class="nx">health</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">maxHealth</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">healRate</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>

        <span class="nx">distanceTraveled</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">range</span><span class="o">:</span> <span class="kc">Infinity</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Instance prototype properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">indexes</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">entityCounts</span><span class="p">.</span><span class="nx">Proj</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Merge in special team attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)){</span>
            <span class="kd">var</span> <span class="nx">teamDefaults</span> <span class="o">=</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">teamDefaults</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">teamDefaults</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">defaults</span><span class="p">){</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({},</span> <span class="nx">teamDefaults</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">)){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">health</span> <span class="o">*=</span> <span class="mf">1.2</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">health</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">maxHealth</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">healRate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;destroy&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="p">{});</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">indexX</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">indexX</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">indexX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">indexY</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">indexY</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">indexY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">entityCounts</span><span class="p">.</span><span class="nx">Proj</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">tick</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;entity - tick&quot;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">alreadyFoundNeighbors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;jerk&quot;</span><span class="p">),</span>
            <span class="nx">accelV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;accel&quot;</span><span class="p">),</span>
            <span class="nx">velV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">),</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">runAI</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">shouldRunAI</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">);</span>

        <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImpulse</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">);</span>

        <span class="nx">accelV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateAcceleration</span><span class="p">(</span><span class="nx">accelV</span><span class="p">,</span> <span class="nx">jerkV</span><span class="p">);</span>

        <span class="nx">velV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateVelocity</span><span class="p">(</span><span class="nx">velV</span><span class="p">,</span> <span class="nx">accelV</span><span class="p">);</span>

        <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">updatePosition</span><span class="p">(</span><span class="nx">posV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runAI</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">runWeaponsAI</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">checkForCollision</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">regenHealth</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">saveUpdatedVectors</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">accelV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">posV</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This entity is done for this tick, so we can give them a fresh tick cache.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="s2">&quot;entity - tick&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">shouldRunAI</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">segments</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">segmentsOverride</span> <span class="o">||</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nx">currentSegment</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">tickPhase</span> <span class="o">%</span> <span class="nx">segments</span><span class="p">,</span>
            <span class="nx">segLoc</span> <span class="o">=</span> <span class="nx">entityIndex</span> <span class="o">/</span> <span class="nx">totalEntities</span><span class="p">,</span>
            <span class="nx">runAI</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Do the AI calculations only if we're in the current segment.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">currentSegment</span><span class="o">/</span><span class="nx">segments</span> <span class="o">&lt;=</span> <span class="nx">segLoc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">currentSegment</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nx">segments</span> <span class="o">&gt;</span> <span class="nx">segLoc</span><span class="p">){</span>
            <span class="nx">runAI</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">runAI</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">getImpulse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">)){</span>

            <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImpulseFromPlayerControl</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runAI</span><span class="p">)</span>
                <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImpulseFromAI</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">constrainVectorMag</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">));</span>

        <span class="k">return</span> <span class="nx">jerkV</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getImpulseFromPlayerControl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">thrustFactor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>87 - w</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">87</span><span class="p">]){</span>
            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)));</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getVectMagGhetto</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;heading&quot;</span><span class="p">))</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
                <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">j</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">rotate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;heading&quot;</span><span class="p">),</span> <span class="nx">Line</span><span class="p">.</span><span class="nx">Z</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">68</span><span class="p">]){</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If no thrust is being applied, circle left.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">))</span> <span class="c1">// Small forward thrust for wide circle.</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">rotate</span><span class="p">(</span><span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">Line</span><span class="p">.</span><span class="nx">Z</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span><span class="o">*</span><span class="nx">thrustFactor</span><span class="p">));</span> <span class="c1">// Left thrust.</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>65 - a</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getVectMagGhetto</span><span class="p">(</span><span class="nx">velV</span><span class="p">)){</span>
            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">rotate</span><span class="p">(</span><span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">Line</span><span class="p">.</span><span class="nx">Z</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span><span class="o">*</span><span class="nx">thrustFactor</span><span class="p">));</span> <span class="c1">// Left thrust.</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>83 - s</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="cm">/*if(app.view.keysPressed[83]){</span>
<span class="cm">            jerkV = this.constrainVectorMag(jerkV.add(velV.toUnitVector().multiply(-1)), this.getVectMag(velV)).multiply(0.5);</span>
<span class="cm">        }*/</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>68 - d</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getVectMagGhetto</span><span class="p">(</span><span class="nx">velV</span><span class="p">)){</span>
            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">rotate</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">Line</span><span class="p">.</span><span class="nx">Z</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span><span class="o">*</span><span class="nx">thrustFactor</span><span class="p">));</span> <span class="c1">// Right thrust.</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>32 - spacebar</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">canFire</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="cm">/* playerControlled */</span> <span class="kc">true</span><span class="p">)){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">fireProjectileAtVect</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">).</span><span class="nx">dup</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">jerkV</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getImpulseFromAI</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">entityIndex</span><span class="p">,</span> <span class="nx">totalEntities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">neighbors</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>

            <span class="nx">neighbors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNeighbors</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;neighborhoodRadius&quot;</span><span class="p">));</span>

            <span class="kd">var</span> <span class="nx">sumHealth</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">entity</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">memo</span> <span class="o">+</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">);</span>
            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>If half of the total health of the neighbors are friends,
avoidance is unchanged.
If alone among enemies, avoid more strongly.
If near more friends than enemies, adjusted for health,
avoidance can be negative, meaning move toward enemies.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">avoidanceFactor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">neighbors</span>
                <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">sumHealth</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span>
            <span class="nx">neighbors</span><span class="p">.</span><span class="nx">chain</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ent</span><span class="p">){</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">ent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">);</span>
            <span class="p">},</span> <span class="k">this</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">sumHealth</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)).</span><span class="nx">value</span><span class="p">())</span> <span class="o">*</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;avoidanceStrength&quot;</span><span class="p">);</span>

            <span class="nx">jerkV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flock</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">avoidOther</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;avoidanceRange&quot;</span><span class="p">)).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">avoidanceFactor</span><span class="p">));</span>

            <span class="cm">/*if(typeof(app.mouseX) != &quot;undefined&quot;) {</span>
<span class="cm">                jerkV = jerkV.add(this.avoidPosition(Vector.create([app.mouseX, app.mouseY, 0]), 150).multiply(100));</span>
<span class="cm">            }*/</span>

            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">avoidPosition</span><span class="p">([</span><span class="mi">75</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">200</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">150</span><span class="p">));</span>

            <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">avoidEdges</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;edgeAvoidanceRange&quot;</span><span class="p">))</span>
                <span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;edgeAvoidanceStrength&quot;</span><span class="p">)));</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getVectMag</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
                <span class="nx">jerkV</span> <span class="o">=</span> <span class="nx">jerkV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">wander</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">jerkV</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">updateAcceleration</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">accelV</span><span class="p">,</span> <span class="nx">jerkV</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxAccel&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">accelV</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">accelV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">constrainVectorMag</span><span class="p">(</span><span class="nx">accelV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">jerkV</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxAccel&quot;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Apply ghetto drag.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">.</span><span class="nx">multiply</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;frictionFactor&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">1</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">accelV</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">updateVelocity</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">velV</span><span class="p">,</span> <span class="nx">accelV</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">velV</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">velV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">constrainVectorMag</span><span class="p">(</span><span class="nx">velV</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">accelV</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Apply ghetto drag.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">.</span><span class="nx">multiply</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;frictionFactor&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">1</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">radians</span> <span class="o">=</span> <span class="nx">velV</span><span class="p">.</span><span class="nx">angleFrom</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">j</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">heading</span> <span class="o">=</span> <span class="nx">velV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="nx">radians</span> <span class="o">:</span> <span class="nx">radians</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nb">isFinite</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">))){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">distanceTraveled</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getVectMag</span><span class="p">(</span><span class="nx">velV</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">distanceTraveled</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">velV</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">updatePosition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">posV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">posV</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">);</span>
        <span class="nx">posV</span> <span class="o">=</span> <span class="nx">posV</span>
            <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">velV</span><span class="p">);</span>

        <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;edgeMode&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;constrain&quot;</span><span class="o">:</span>
                <span class="nx">posV</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">constrainValue</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">constrainValue</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">]);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;destroy&quot;</span><span class="o">:</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">||</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Wrap edge to edge.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">posV</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">wrapValue</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="o">+</span><span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="o">-</span><span class="nx">radius</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">wrapValue</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="o">+</span><span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="o">-</span><span class="nx">radius</span><span class="p">),</span> <span class="mi">0</span><span class="p">]);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">posV</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">checkForCollision</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;doCollisionChecks&quot;</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">neighbors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNeighbors</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;collisionRadius&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span>
            <span class="nx">entity</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getClosestEntity</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Prevent friendly fire.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;firedBy&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;firedBy&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">));</span>
            <span class="p">},</span> <span class="k">this</span><span class="p">)));</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">entity</span> <span class="o">&amp;&amp;</span> <span class="nx">entity</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;firedBy&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">entity</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)){</span>
            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isWithinDistanceGhetto</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">,</span>
                <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;collisionRadius&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">))</span> <span class="o">+</span>
                <span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;collisionRadius&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">)))</span>
            <span class="p">)){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">collisionCallback</span><span class="p">(</span><span class="nx">entity</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">regenHealth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Heal a small amount each tick.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;healRate&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxHealth&quot;</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">heal</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;healRate&quot;</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxHealth&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">saveUpdatedVectors</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jerkV</span><span class="p">,</span> <span class="nx">accelV</span><span class="p">,</span> <span class="nx">velV</span><span class="p">,</span> <span class="nx">posV</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">jerk</span>  <span class="o">=</span> <span class="nx">jerkV</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">accel</span> <span class="o">=</span> <span class="nx">accelV</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">vel</span>   <span class="o">=</span> <span class="nx">velV</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">pos</span>   <span class="o">=</span> <span class="nx">posV</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">runWeaponsAI</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">playerControlled</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">),</span>
            <span class="nx">targets</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Proj</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;autoFire&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canFire</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">playerControlled</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="nx">targets</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectTargets</span><span class="p">(</span><span class="nx">playerControlled</span><span class="p">);</span>

        <span class="nx">_</span><span class="p">(</span><span class="nx">targets</span><span class="p">).</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">fireProjectileAt</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Keep firing until we can't or we run out of targets.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">canFire</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">playerControlled</span><span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">selectTargets</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">playerControlled</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span><span class="p">;</span>

        <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNeighbors</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;neighborhoodRadius&quot;</span><span class="p">)).</span><span class="nx">chain</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Grab the neighbors of other colors (if any).</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Select the ones with the lowest health.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">.</span><span class="nx">allMin</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If there's more than one returned,
(they could all be full health)
pick the closest ones (could still be more
than one if they are at equal distances).</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">.</span><span class="nx">allMin</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDistanceGhetto</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">));</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">target</span><span class="p">.</span><span class="nx">isArray</span><span class="p">()</span> <span class="o">?</span> <span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">()</span> <span class="o">:</span> <span class="p">[</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">()];</span>
    <span class="p">},</span>

    <span class="nx">canFire</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">playerControlled</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Firing rate is projectiles per second.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">time</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">time</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;lastFired&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;firingRate&quot;</span><span class="p">))</span><span class="cm">/* &amp;&amp;</span>
<span class="cm">            (playerControlled || app.entityCounts.Proj &lt; app.entities.size()/2)*/</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">fireProjectileAt</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">at</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">atPosV</span> <span class="o">=</span> <span class="nx">at</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">atVelV</span> <span class="o">=</span> <span class="nx">at</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">),</span>

            <span class="nx">distance</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">atPosV</span><span class="p">),</span>
            <span class="nx">ticksToAt</span> <span class="o">=</span> <span class="nx">distance</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;muzzleVel&quot;</span><span class="p">),</span>

            <span class="nx">accuracyFactor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">),</span>

            <span class="nx">atV</span> <span class="o">=</span> <span class="nx">atPosV</span><span class="p">.</span><span class="nx">dup</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Skate to where the puck is going to be.
1.2 is THE magic number.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">atVelV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">ticksToAt</span><span class="o">*</span><span class="p">(</span><span class="mf">1.2</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">accuracyFactor</span><span class="o">-</span><span class="p">(</span><span class="nx">accuracyFactor</span><span class="o">/</span><span class="mi">2</span><span class="p">)))));</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">fireProjectileAtVect</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">atV</span><span class="p">,</span> <span class="nx">at</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">fireProjectileAtVect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">atV</span><span class="p">,</span> <span class="nx">at</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            
            <span class="nx">projectiles</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">projVel</span> <span class="o">=</span> <span class="nx">atV</span>
                <span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">posV</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;muzzleVel&quot;</span><span class="p">));</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">projectiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Proj</span><span class="p">({</span>
                <span class="nx">color</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
                <span class="nx">radius</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nx">pos</span><span class="o">:</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">dup</span><span class="p">(),</span>
                <span class="nx">vel</span><span class="o">:</span> <span class="nx">projVel</span><span class="p">.</span><span class="nx">dup</span><span class="p">(),</span>
                <span class="nx">range</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;weaponRange&quot;</span><span class="p">),</span>
                <span class="nx">firedBy</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span>
                <span class="nx">firedAt</span><span class="o">:</span> <span class="nx">at</span>
            <span class="p">}));</span>
        <span class="p">}</span>
        
        <span class="nx">_</span><span class="p">(</span><span class="nx">projectiles</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">ProjView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">proj</span> <span class="p">});</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">lastFired</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">lastAnimationTime</span><span class="p">;</span>

        <span class="cm">/*app.projectiles.add(projectiles);*/</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">projectiles</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">kill</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>

            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">posX</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="nx">posY</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>

            <span class="nx">radius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">respawn</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">color</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">radius</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">radius</span><span class="p">,</span> <span class="nx">posY</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">radius</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">radius</span><span class="p">,</span> <span class="p">(</span><span class="nx">radius</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="nx">radius</span><span class="o">/</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">color</span><span class="p">]</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">color</span><span class="p">]</span> <span class="o">||</span> <span class="p">{</span> <span class="nx">kills</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">deaths</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">color</span><span class="p">].</span><span class="nx">deaths</span><span class="o">++</span><span class="p">;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">renderKillStats</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">injure</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">damage</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newHealth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">damage</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">newHealth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">health</span> <span class="o">=</span> <span class="nx">newHealth</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">heal</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">amount</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newHealth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">amount</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">health</span> <span class="o">=</span> <span class="nx">newHealth</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">respawn</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
            <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
            <span class="nx">playerControlled</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">);</span>

        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span>
                <span class="nx">playerControlled</span> <span class="o">?</span> <span class="p">{</span>
                    <span class="nx">playerControlled</span><span class="o">:</span> <span class="nx">playerControlled</span>
                <span class="p">}</span> <span class="o">:</span> <span class="p">{</span>
                    <span class="nx">color</span><span class="o">:</span> <span class="nx">color</span>
                <span class="p">}</span>
            <span class="p">);</span>
            
            <span class="k">if</span><span class="p">(</span><span class="nx">playerControlled</span><span class="p">){</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">;</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">entity</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">());</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span><span class="nx">entity</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">());</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span><span class="mi">0</span><span class="p">);</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">);</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
            <span class="p">}</span>

        <span class="p">},</span> <span class="mi">1000</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2000</span><span class="p">));</span>
    <span class="p">},</span>

    <span class="nx">getNeighbors</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The tickCache is deleted after the tick,
so it should only exist if it's been calculated in this tick.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighbors</span> <span class="o">&amp;&amp;</span> <span class="nx">neighborhoodRadius</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastNeighborhoodRadius</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighbors</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">lastNeighborhoodRadius</span> <span class="o">=</span> <span class="nx">neighborhoodRadius</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighbors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">findNeighbors</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">findNeighbors</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*var neighborsNaive = this.findNeighborsNaive(entities, neighborhoodRadius),</span>
<span class="cm">            neighborsFromSorted = this.findNeighborsFromSorted(entities, neighborhoodRadius);</span>

<span class="cm">        if(neighborsNaive.length != neighborsFromSorted.length)</span>
<span class="cm">            console.error(&quot;Neighbor lists are not equal length!&quot;);</span>

<span class="cm">        return neighborsNaive;</span>

<span class="cm">        return this.findNeighborsNaive(entities, neighborhoodRadius);*/</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">findNeighborsFromSorted</span><span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">findNeighborsNaive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">neighbors</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">walked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span> <span class="o">===</span> <span class="nx">me</span> <span class="o">||</span> <span class="nx">entity</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
                <span class="nx">distance</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">);</span>

            <span class="nx">walked</span><span class="o">++</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">neighborhoodRadius</span><span class="p">){</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}));</span>

        <span class="k">return</span> <span class="nx">neighbors</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">findNeighborsFromSorted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">alreadyFoundNeighbors</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Expensive op: Calculating neighbors for entity &gt; once during same tick.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">posInX</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="nx">posInY</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Get close entities in the indexes.posX list.
Error is introduced by walkSortedList proportional to the distance
that the entities have moved, since their pos vectors are up-to-date
but the sort order of the indexes list is not.
This especially causes significant error when an entity wraps around the map.
This could be improved by sorting after every Entity moves,
at the cost of performance implications.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">neighbors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span> <span class="o">?</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span><span class="p">)</span> <span class="o">:</span>
                <span class="p">[],</span>
            <span class="nx">filteredEntities</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">seen</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span> <span class="o">||</span> <span class="p">{}),</span>

            <span class="nx">walkLimit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;walkLimit&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">,</span>

            <span class="nx">sortedListX</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span><span class="p">,</span>
            <span class="nx">sortedListY</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span><span class="p">,</span>

            <span class="nx">sortedIndexX</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosX</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosX</span> <span class="o">:</span>
                            <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span><span class="p">(</span><span class="nx">sortedListX</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span> <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">();</span> <span class="p">}),</span>
            <span class="nx">sortedIndexY</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosY</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">?</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosY</span> <span class="o">:</span>
                             <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span><span class="p">(</span><span class="nx">sortedListY</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span> <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span> <span class="p">});</span>

        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">filteredEntities</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">walkSortedList</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">sortedIndexX</span><span class="p">,</span> <span class="nx">sortedListX</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="nx">neighborhoodRadius</span><span class="p">,</span> <span class="nx">posInX</span><span class="p">,</span> <span class="nx">walkLimit</span><span class="p">));</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">filteredEntities</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">walkSortedList</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">sortedIndexX</span><span class="p">,</span> <span class="nx">sortedListX</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">,</span> <span class="nx">posInX</span><span class="p">,</span> <span class="nx">walkLimit</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Get close entities in the indexes.posY list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">filteredEntities</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">walkSortedList</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">sortedIndexY</span><span class="p">,</span> <span class="nx">sortedListY</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="nx">neighborhoodRadius</span><span class="p">,</span> <span class="nx">posInY</span><span class="p">,</span> <span class="nx">walkLimit</span><span class="p">));</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">filteredEntities</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">walkSortedList</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">sortedIndexY</span><span class="p">,</span> <span class="nx">sortedListY</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">,</span> <span class="nx">posInY</span><span class="p">,</span> <span class="nx">walkLimit</span><span class="p">));</span>

        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="nx">filteredEntities</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isWithinDistanceGhetto</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)){</span>

                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span><span class="p">[</span><span class="nx">entity</span><span class="p">.</span><span class="nx">cid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span><span class="p">)</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">entity</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighborsSeen</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">cid</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">));</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">alreadyFoundNeighbors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">neighbors</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">walkSortedList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">sortedIndex</span><span class="p">,</span> <span class="nx">sortedList</span><span class="p">,</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">posInAxis</span><span class="p">,</span> <span class="nx">walkLimit</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">foundEntities</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">highDist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">listLength</span> <span class="o">=</span> <span class="nx">sortedList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">?</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">currIndex</span> <span class="o">=</span> <span class="nx">sortedIndex</span><span class="p">,</span>
            <span class="nx">posFunc</span> <span class="o">=</span> <span class="nx">axis</span> <span class="o">===</span> <span class="s2">&quot;x&quot;</span> <span class="o">?</span> <span class="s2">&quot;getPosX&quot;</span> <span class="o">:</span> <span class="s2">&quot;getPosY&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Account for trying to use the sorted list
from an entity not on the list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="cm">/*if(currIndex === -1){</span>
<span class="cm">            console.warn(&quot;Expensive op: Called walkSortedList() from entity not on sorted list.&quot;);</span>

<span class="cm">            var closestEntity = this.getClosestEntity(sortedList);</span>
<span class="cm">            currIndex = _.indexOf(sortedList, _.find(sortedList, function(entity){</span>
<span class="cm">                return entity === closestEntity;</span>
<span class="cm">            }));</span>
<span class="cm">        }*/</span>

        <span class="kd">var</span> <span class="nx">walked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span> <span class="nx">currIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">currIndex</span> <span class="o">&lt;</span> <span class="nx">listLength</span> <span class="o">&amp;&amp;</span> <span class="nx">highDist</span> <span class="o">&lt;</span> <span class="nx">range</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">walkLimit</span> <span class="o">||</span> <span class="nx">walked</span> <span class="o">&lt;</span> <span class="nx">walkLimit</span><span class="p">)</span> <span class="p">){</span>
            <span class="kd">var</span> <span class="nx">entity</span> <span class="o">=</span> <span class="nx">sortedList</span><span class="p">[</span><span class="nx">currIndex</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">seen</span><span class="p">[</span><span class="nx">entity</span><span class="p">.</span><span class="nx">cid</span><span class="p">]){</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">entity</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">entity</span> <span class="o">!==</span> <span class="k">this</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">thisPosInAxis</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">[</span><span class="nx">posFunc</span><span class="p">]();</span>

                    <span class="nx">foundEntities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">entity</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Using ternary rather than Math.abs
http://jsperf.com/math-abs-perf-vs-ternary</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="cm">/*highDist = Math.abs(thisPosInAxis - posInAxis);*/</span>
                    <span class="nx">highDist</span> <span class="o">=</span> <span class="nx">thisPosInAxis</span> <span class="o">&gt;</span> <span class="nx">posInAxis</span> <span class="o">?</span>
                        <span class="nx">thisPosInAxis</span> <span class="o">-</span> <span class="nx">posInAxis</span> <span class="o">:</span>
                        <span class="nx">posInAxis</span> <span class="o">-</span> <span class="nx">thisPosInAxis</span><span class="p">;</span>
                    <span class="nx">walked</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">seen</span><span class="p">[</span><span class="nx">entity</span><span class="p">.</span><span class="nx">cid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">currIndex</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">foundEntities</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getDistanceGhetto</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">vect</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sum</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">isWithinDistanceGhetto</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="nx">distance</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDistanceGhetto</span><span class="p">(</span><span class="nx">vect</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">distance</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getClosestEntity</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">closest</span><span class="p">,</span>
            <span class="nx">lastDistance</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>

        <span class="nx">_</span><span class="p">(</span><span class="nx">entities</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
                <span class="nx">distanceGhetto</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDistanceGhetto</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">distanceGhetto</span> <span class="o">&lt;</span> <span class="nx">lastDistance</span><span class="p">){</span>
                <span class="nx">closest</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">;</span>
                <span class="nx">lastDistance</span> <span class="o">=</span> <span class="nx">distanceGhetto</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">closest</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">wander</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">randomizeSign</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">));</span> <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">tempJerk</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Random</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">to3D</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">randomizeSign</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radsToDegrees</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">).</span><span class="nx">angleFrom</span><span class="p">(</span><span class="nx">tempJerk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">tempJerk</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxJerk&quot;</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">flock</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">cohere</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;cohesionRange&quot;</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;cohesionStrength&quot;</span><span class="p">))</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">align</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;alignmentRange&quot;</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;alignmentStrength&quot;</span><span class="p">)))</span>
                <span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">separate</span><span class="p">(</span><span class="nx">neighbors</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;separationRange&quot;</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;separationStrength&quot;</span><span class="p">)));</span>
    <span class="p">},</span>

    <span class="nx">cohere</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">sum</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">color</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isWithinDistanceGhetto</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)){</span>
                <span class="nx">sum</span> <span class="o">=</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">);</span>
                <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">sum</span> <span class="o">=</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">count</span><span class="p">;</span> <span class="p">});</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">steerTo</span><span class="p">(</span><span class="nx">sum</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span> <span class="c1">// Empty vector contributes nothing</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">steerTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">desiredV</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">posV</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">distance</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getVectMag</span><span class="p">(</span><span class="nx">desiredV</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">desiredV</span> <span class="o">=</span> <span class="nx">desiredV</span><span class="p">.</span><span class="nx">toUnitVector</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Two options for desired vector magnitude (1 -- based on distance, 2 -- maxspeed)</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">steerDampingDistance</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;steerDampingDistance&quot;</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">steerDampingDistance</span><span class="p">){</span>
                <span class="nx">desiredV</span> <span class="o">=</span> <span class="nx">desiredV</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">distance</span><span class="o">/</span><span class="nx">steerDampingDistance</span><span class="p">));</span> <span class="c1">// This damping is somewhat arbitrary</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">desiredV</span> <span class="o">=</span> <span class="nx">desiredV</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">steer</span> <span class="o">=</span> <span class="nx">desiredV</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">));</span>

            <span class="k">return</span> <span class="nx">steer</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">align</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">color</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
                <span class="nx">entityVelV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isWithinDistanceGhetto</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">,</span> <span class="nx">neighborhoodRadius</span><span class="p">)){</span>
                <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">entityVelV</span><span class="p">);</span>
                <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">count</span><span class="p">;</span> <span class="p">}).</span><span class="nx">toUnitVector</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">mean</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">separate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">desiredDistance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>

            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">color</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
                <span class="nx">distance</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">desiredDistance</span><span class="p">){</span>
                <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">distance</span><span class="p">;</span> <span class="p">}));</span>
                <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">count</span><span class="p">;</span> <span class="p">});</span>

        <span class="k">return</span> <span class="nx">mean</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">avoidOther</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">desiredDistance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">),</span>
            <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>

            <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">color</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">entityPosV</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
                <span class="nx">distance</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">desiredDistance</span><span class="p">){</span>
                <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">posV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">entityPosV</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">distance</span><span class="p">;</span> <span class="p">}));</span>
                <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">mean</span> <span class="o">=</span> <span class="nx">mean</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">count</span><span class="p">;</span> <span class="p">});</span>

        <span class="k">return</span> <span class="nx">mean</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">avoidPosition</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">avoidV</span><span class="p">,</span> <span class="nx">desiredDistance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
            <span class="nx">distance</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">avoidV</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">desiredDistance</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">dup</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">avoidV</span><span class="p">).</span><span class="nx">toUnitVector</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">distance</span><span class="p">;</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">avoidEdges</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">desiredDistance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posV</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>

            <span class="nx">distanceFromLeft</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="nx">distanceFromRight</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">-</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="nx">distanceFromTop</span> <span class="o">=</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="nx">distanceFromBottom</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span> <span class="o">-</span> <span class="nx">posV</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>

            <span class="nx">vect</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distanceFromLeft</span> <span class="o">&lt;=</span> <span class="nx">desiredDistance</span><span class="p">)</span>
            <span class="nx">vect</span> <span class="o">=</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distanceFromRight</span> <span class="o">&lt;=</span> <span class="nx">desiredDistance</span><span class="p">)</span>
            <span class="nx">vect</span> <span class="o">=</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distanceFromTop</span> <span class="o">&lt;=</span> <span class="nx">desiredDistance</span><span class="p">)</span>
            <span class="nx">vect</span> <span class="o">=</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">distanceFromBottom</span> <span class="o">&lt;=</span> <span class="nx">desiredDistance</span><span class="p">)</span>
            <span class="nx">vect</span> <span class="o">=</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nx">vect</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">collisionCallback</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span> <span class="cm">/* No-op by default. */</span> <span class="p">},</span>

    <span class="nx">radsToDegrees</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rads</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>degrees = radians * (180/pi)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">rads</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">degreesToRads</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">degrees</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>radians = degrees * (pi/180)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">degrees</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getVectMag</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getVectMagGhetto</span><span class="p">(</span><span class="nx">vect</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">getVectMagGhetto</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sumPow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">vect</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sumPow</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">sumPow</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">constrainVectorMag</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="nx">maxMag</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getVectMag</span><span class="p">(</span><span class="nx">vect</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">mag</span><span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">mag</span> <span class="o">&gt;</span> <span class="nx">maxMag</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">maxMag</span><span class="o">/</span><span class="nx">mag</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">vect</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">constrainValue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">max</span><span class="p">,</span> <span class="nx">min</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">min</span> <span class="o">=</span> <span class="nx">min</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">max</span> <span class="o">?</span> <span class="nx">max</span> <span class="o">:</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">min</span> <span class="o">?</span> <span class="nx">min</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">wrapValue</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">max</span><span class="p">,</span> <span class="nx">min</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">min</span> <span class="o">=</span> <span class="nx">min</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">max</span> <span class="o">?</span> <span class="nx">min</span> <span class="o">:</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">min</span> <span class="o">?</span> <span class="nx">max</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">getElemFromVect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">vect</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getPosX</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Accessing this directly for performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="cm">/*return this.getElemFromVect(this.get(&quot;pos&quot;), 1);*/</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">getPosY</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Accessing this directly for performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="cm">/*return this.getElemFromVect(this.get(&quot;pos&quot;), 2);*/</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">},</span>

    <span class="nx">getVelX</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">getVelY</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getAccelX</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;accel&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">getAccelY</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;accel&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getJerkX</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;jerk&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">getJerkY</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getElemFromVect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;jerk&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">handleError</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;error on entity: &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">cid</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Class properties.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span>
    <span class="nx">compareByPosX</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entityA</span><span class="p">,</span> <span class="nx">entityB</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posXA</span> <span class="o">=</span> <span class="nx">entityA</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span>
            <span class="nx">posXB</span> <span class="o">=</span> <span class="nx">entityB</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">posXA</span> <span class="o">-</span> <span class="nx">posXB</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">compareByPosY</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entityA</span><span class="p">,</span> <span class="nx">entityB</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posYA</span> <span class="o">=</span> <span class="nx">entityA</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">(),</span>
            <span class="nx">posYB</span> <span class="o">=</span> <span class="nx">entityB</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">posYA</span> <span class="o">-</span> <span class="nx">posYB</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">_</span><span class="p">.</span><span class="nx">mixin</span><span class="p">({</span>
    <span class="nx">allMin</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">computed</span> <span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">[]};</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">computed</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">?</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">computed</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">computed</span><span class="p">){</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span> <span class="o">:</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">computed</span> <span class="o">:</span> <span class="nx">computed</span><span class="p">};</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">computed</span> <span class="o">===</span> <span class="nx">result</span><span class="p">.</span><span class="nx">computed</span><span class="p">){</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Entity</span><span class="p">.</span><span class="nx">teamDefaults</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Speed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">green</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">firingRate</span><span class="o">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="nx">maxVel</span><span class="o">:</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">maxVel</span><span class="o">*</span><span class="mf">1.4</span><span class="p">,</span>
        <span class="nx">maxAccel</span><span class="o">:</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">maxAccel</span><span class="o">*</span><span class="mf">1.6</span><span class="p">,</span>
        <span class="nx">damage</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>

        <span class="nx">avoidanceRange</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">avoidanceStength</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="nx">separationRange</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="nx">alignmentStrength</span><span class="o">:</span> <span class="mf">2.5</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Firepower</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">red</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">firingRate</span><span class="o">:</span> <span class="mf">4.2</span><span class="p">,</span>
        <span class="nx">maxVel</span><span class="o">:</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">maxVel</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span>

        <span class="nx">accuracy</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

        <span class="nx">cohesionRange</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">cohesionStrength</span><span class="o">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="nx">separationRange</span><span class="o">:</span> <span class="mi">25</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Health</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">blue</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">health</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">maxHealth</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">healRate</span><span class="o">:</span> <span class="mf">0.15</span><span class="p">,</span>

        <span class="nx">avoidanceRange</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">cohesionRange</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">cohesionStrength</span><span class="o">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="nx">separationRange</span><span class="o">:</span> <span class="mi">25</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Sniper</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">orange</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">damage</span><span class="o">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="nx">health</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="nx">healRate</span><span class="o">:</span> <span class="mf">0.2</span><span class="p">,</span>

        <span class="nx">accuracy</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">muzzleVel</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>

        <span class="nx">neighborhoodRadius</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>

        <span class="nx">cohesionRange</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">cohesionStrength</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="nx">separationRange</span><span class="o">:</span> <span class="mi">95</span><span class="p">,</span>
        <span class="nx">separationStrength</span><span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="nx">alignmentRange</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="nx">alignmentStrength</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">EntityView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

    <span class="nx">tagName</span><span class="o">:</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;entity&#39;</span><span class="p">,</span>
    
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;click&#39;</span><span class="o">:</span> <span class="s1">&#39;handleClick&#39;</span>
    <span class="p">},</span>

    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nx">time</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;entity - render&quot;</span><span class="p">);</span>
        
        <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">),</span>
            <span class="nx">diam</span> <span class="o">=</span> <span class="nx">radius</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">jerkX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getJerkX</span><span class="p">(),</span>
            <span class="nx">jerkY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getJerkY</span><span class="p">(),</span>
            <span class="nx">accelX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getAccelX</span><span class="p">(),</span>
            <span class="nx">accelY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getAccelY</span><span class="p">(),</span>
            <span class="nx">velX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getVelX</span><span class="p">(),</span>
            <span class="nx">velY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getVelY</span><span class="p">(),</span>
            <span class="nx">posX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span>
            <span class="nx">posY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Render entity on a canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">renderEntity</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">,</span> <span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Draw color trail.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">velMag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getVectMag</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">([</span><span class="nx">velX</span><span class="p">,</span> <span class="nx">velY</span><span class="p">,</span> <span class="mi">0</span><span class="p">]));</span>
        <span class="kd">var</span> <span class="nx">trailRad</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxVel&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="nx">velMag</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="nx">trailRad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Draw neighbor mesh.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">drawFlockMesh</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">neighbors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">tickCache</span><span class="p">.</span><span class="nx">neighbors</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">neighbors</span> <span class="o">&amp;&amp;</span> <span class="nx">neighbors</span><span class="p">.</span><span class="nx">size</span><span class="p">()){</span>
                <span class="nx">neighbors</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">drawLineTo</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">(),</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Draw neighborhood.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">drawRanges</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Draw danger zone.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">drawVectors</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)){</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Draw position indicator.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="cm">/*this.drawDirectionalIndicator(app.overlayCtx, 0-posX, 0-posY, 1, &quot;black&quot;, 1);*/</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Draw velocity indicator.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="cm">/*this.drawDirectionalIndicator(app.overlayCtx, velX, velY, 5, &quot;#F9D300&quot;);*/</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Draw accel indicator.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">drawDirectionalIndicator</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">,</span> <span class="nx">accelX</span><span class="p">,</span> <span class="nx">accelY</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Draw jerk indicator.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">drawDirectionalIndicator</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">,</span> <span class="nx">jerkX</span><span class="p">,</span> <span class="nx">jerkY</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">)){</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Draw player dot.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">drawHealthIndicators</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)){</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Draw health dot.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">healthRad</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="nx">healthRad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Draw smoke for damaged entity.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxHealth&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">tickPhase</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Proj</span><span class="p">)){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="nx">posY</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nx">time</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="s2">&quot;entity - render&quot;</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">renderEntity</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">);</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">;</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span><span class="nx">posY</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;heading&quot;</span><span class="p">));</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="nx">radius</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="nx">radius</span><span class="p">,</span><span class="mi">0</span><span class="o">-</span><span class="nx">radius</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="nx">radius</span><span class="p">,</span><span class="mi">0</span><span class="o">-</span><span class="nx">radius</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalAlpha</span><span class="o">=</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;health&quot;</span><span class="p">)</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;maxHealth&quot;</span><span class="p">))</span><span class="o">*</span><span class="mf">0.9</span><span class="o">+</span><span class="mf">0.1</span><span class="p">;</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalAlpha</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">drawDirectionalIndicator</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">diffX</span><span class="p">,</span> <span class="nx">diffY</span><span class="p">,</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span>
            <span class="nx">posY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span>

        <span class="nx">scale</span> <span class="o">=</span> <span class="nx">scale</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">drawLineTo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">posX</span><span class="o">+</span><span class="p">(</span><span class="nx">diffX</span><span class="o">*</span><span class="nx">scale</span><span class="p">),</span> <span class="nx">posY</span><span class="o">+</span><span class="p">(</span><span class="nx">diffY</span><span class="o">*</span><span class="nx">scale</span><span class="p">),</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">width</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">drawLineTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span>
            <span class="nx">posY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span><span class="nx">posY</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span><span class="o">=</span><span class="nx">style</span><span class="o">||</span><span class="s2">&quot;#F9D300&quot;</span><span class="p">;</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span><span class="o">=</span><span class="nx">width</span><span class="o">||</span><span class="mi">3</span><span class="p">;</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">move</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">(),</span>
            <span class="nx">posY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span>
            <span class="nx">top</span><span class="o">:</span> <span class="nx">posY</span><span class="o">+</span><span class="s2">&quot;px&quot;</span><span class="p">,</span>
            <span class="nx">left</span><span class="o">:</span> <span class="nx">posX</span><span class="o">+</span><span class="s2">&quot;px&quot;</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">handleClick</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;you clicked the entity: &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">cid</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">EntityCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">model</span><span class="o">:</span> <span class="nx">Entity</span><span class="p">,</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">indexes</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">},</span>

    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">modelList</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="o">?</span> <span class="nx">models</span> <span class="o">:</span> <span class="p">[</span><span class="nx">models</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Delegate to the real Backbone.Collection#add</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">ProjCollection</span><span class="p">))</span> <span class="nx">_</span><span class="p">(</span><span class="nx">modelList</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">insertSorted</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">spawnEntities</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">,</span> <span class="nx">$container</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">EntityCollection</span><span class="p">.</span><span class="nx">spawnEntities</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">$container</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">spawnEntity</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">$container</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">EntityCollection</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">$container</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">sortEntities</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">EntityCollection</span><span class="p">.</span><span class="nx">sortEntities</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">insertSorted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">EntityCollection</span><span class="p">.</span><span class="nx">insertSorted</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getIndex</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexes</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Class properties</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span>

    <span class="nx">spawnEntities</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">num</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">entities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Saving the code for two teams, for ease of switching.
Need to make teams configurable soon.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="cm">/*color: i % 2  ? &quot;blue&quot; : &quot;red&quot;,*/</span>
                <span class="nx">color</span><span class="o">:</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;blue&quot;</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="s2">&quot;red&quot;</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">?</span> <span class="s2">&quot;green&quot;</span> <span class="o">:</span> <span class="s2">&quot;orange&quot;</span>
            <span class="p">}));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">entities</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">spawnEntity</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">obj</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">rand</span> <span class="o">=</span> <span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">color</span> <span class="o">?</span> <span class="nx">app</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="nx">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Entity</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
                <span class="nx">vel</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                <span class="nx">accel</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                <span class="nx">jerk</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Zero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                <span class="nx">color</span><span class="o">:</span> <span class="nx">rand</span> <span class="o">&lt;=</span> <span class="mf">0.25</span> <span class="o">?</span> <span class="s2">&quot;blue&quot;</span> <span class="o">:</span> <span class="nx">rand</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">?</span> <span class="s2">&quot;red&quot;</span> <span class="o">:</span> <span class="nx">rand</span> <span class="o">&lt;=</span> <span class="mf">0.75</span> <span class="o">?</span> <span class="s2">&quot;green&quot;</span> <span class="o">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                <span class="nx">pos</span><span class="o">:</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">([</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
            <span class="p">},</span> <span class="nx">obj</span><span class="p">));</span>
        
        <span class="k">new</span> <span class="nx">EntityView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">entity</span> <span class="p">});</span>
        
        <span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">entity</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">entity</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Takes a collection of Entities and updates its custom indexes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">sortEntities</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">coll</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posXArr</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span> <span class="o">||</span> <span class="p">[]),</span>
            <span class="nx">posYArr</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span> <span class="o">||</span> <span class="p">[]);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">posXArr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">posXArr</span><span class="p">,</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">slice</span><span class="p">());</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">posYArr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">posYArr</span><span class="p">,</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">slice</span><span class="p">());</span>

        <span class="nx">posXArr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">compareByPosX</span><span class="p">);</span>
        <span class="nx">posYArr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">Entity</span><span class="p">.</span><span class="nx">compareByPosY</span><span class="p">);</span>

        <span class="nx">_</span><span class="p">(</span><span class="nx">posXArr</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span><span class="p">){</span>
            <span class="nx">entity</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosX</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="nx">_</span><span class="p">(</span><span class="nx">posYArr</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span><span class="p">){</span>
            <span class="nx">entity</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosY</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">insertSorted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">coll</span><span class="p">,</span> <span class="nx">entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posXArr</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posX</span> <span class="o">||</span> <span class="p">[]),</span>
            <span class="nx">posYArr</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">posY</span> <span class="o">||</span> <span class="p">[]),</span>

            <span class="nx">indexX</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span><span class="p">(</span><span class="nx">posXArr</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span> <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosX</span><span class="p">();</span> <span class="p">}),</span>
            <span class="nx">indexY</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span><span class="p">(</span><span class="nx">posYArr</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entity</span><span class="p">){</span> <span class="k">return</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">getPosY</span><span class="p">();</span> <span class="p">});</span>

        <span class="nx">entity</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosX</span> <span class="o">=</span> <span class="nx">indexX</span><span class="p">;</span>
        <span class="nx">entity</span><span class="p">.</span><span class="nx">indexes</span><span class="p">.</span><span class="nx">byPosY</span> <span class="o">=</span> <span class="nx">indexY</span><span class="p">;</span>

        <span class="nx">posXArr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">indexX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span>
        <span class="nx">posYArr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">indexY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">Proj</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Proj</span> <span class="o">=</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">defaults</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">Entity</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">maxJerk</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">maxAccel</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">maxVel</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span>
        <span class="nx">frictionFactor</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

        <span class="nx">edgeMode</span><span class="o">:</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span>
        <span class="nx">doCollisionChecks</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

        <span class="nx">walkLimit</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">}),</span>

    <span class="nx">kill</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">collisionCallback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">firedBy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;firedBy&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Enityi#injure returns true when the injury was fatal.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">injure</span><span class="p">((</span><span class="nx">firedBy</span> <span class="o">&amp;&amp;</span> <span class="nx">firedBy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;damage&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">firedBy</span><span class="p">){</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">firedBy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">firedBy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)]</span> <span class="o">||</span> <span class="p">{</span> <span class="nx">kills</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">deaths</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">[</span><span class="nx">firedBy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)].</span><span class="nx">kills</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">renderKillStats</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">ProjView</span> <span class="o">=</span> <span class="nx">EntityView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;entity proj&#39;</span><span class="p">,</span>

    <span class="nx">renderEntity</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">);</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>arc(centerX, centerY, radius, 0, 2 * Math.PI, false);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">posX</span><span class="p">,</span> <span class="nx">posY</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">ProjCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">Proj</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">AppModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">$el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#app&quot;</span><span class="p">)).</span><span class="nx">$el</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppModel</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">keysPressed</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">recordKeydown</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">recordKeyup</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>

        <span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span>
            <span class="nx">width</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span>
            <span class="nx">height</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span>
        <span class="p">});</span>
        
        <span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">entities</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EntityCollection</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">projectiles</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">projectiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProjCollection</span><span class="p">();</span>
        
        <span class="nx">entities</span><span class="p">.</span><span class="nx">spawnEntities</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="nx">$el</span><span class="p">);</span>
        <span class="nx">entities</span><span class="p">.</span><span class="nx">spawnEntity</span><span class="p">({</span>
            <span class="nx">playerControlled</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">},</span> <span class="nx">$el</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">backdrop</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">backdrop</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#backdrop&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">backdrop</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">;</span>
        <span class="nx">backdrop</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">overlay</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#overlay&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">overlay</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">;</span>
        <span class="nx">overlay</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">;</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">backdropCtx</span> <span class="o">=</span> <span class="nx">backdrop</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">overlayCtx</span> <span class="o">=</span> <span class="nx">overlay</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>any user events (clicks etc) we want to respond to</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="s2">&quot;mousemove&quot;</span><span class="o">:</span> <span class="s2">&quot;recordMousemove&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mousedown&quot;</span><span class="o">:</span> <span class="s2">&quot;recordMousedown&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mouseup&quot;</span><span class="o">:</span> <span class="s2">&quot;recordMouseup&quot;</span>
    <span class="p">},</span>

    <span class="nx">recordMousemove</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">offset</span><span class="p">();</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">mouseX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="o">-</span><span class="nx">offset</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">mouseY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="o">-</span><span class="nx">offset</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">recordMousedown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">mousedown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">recordMouseup</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">mousedown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">recordKeydown</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">recordKeyup</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">keysPressed</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">handleClick</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>

    <span class="nx">firePlayerControlled</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">([</span><span class="nx">app</span><span class="p">.</span><span class="nx">mouseX</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">mouseY</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">chain</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ent</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">ent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;playerControlled&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ent</span><span class="p">.</span><span class="nx">canFire</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="cm">/* playerControlled */</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ent</span><span class="p">){</span>
            <span class="nx">ent</span><span class="p">.</span><span class="nx">fireProjectileAtVect</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>This code launches projectiles in random directions
from the location of a mouse click.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/*handleClick: function (e) {</span>
<span class="cm">        var randomizeSign = function(x){ return x * Math.pow(-1, Math.round(Math.random()*10)); };</span>
<span class="cm">        var projectiles = [];</span>
<span class="cm">        for(var i = 0; i &lt; 10; i++){</span>
<span class="cm">            projectiles.push(new Proj({</span>
<span class="cm">                color: &quot;black&quot;,</span>
<span class="cm">                radius: 2,</span>
<span class="cm">                range: 150,</span>
<span class="cm">                pos: Vector.create([app.mouseX, app.mouseY, 0]),</span>
<span class="cm">                vel: Vector.Random(2).to3D().map(randomizeSign).toUnitVector().multiply(Proj.prototype.defaults.maxVel)</span>
<span class="cm">            }));</span>
<span class="cm">        }</span>

<span class="cm">        var $container = this.$el;</span>
<span class="cm">        var elems = [];</span>
<span class="cm">        </span>
<span class="cm">        _(projectiles).each(function (proj) {</span>
<span class="cm">            elems.push((new ProjView({ model: proj })).render().el);</span>
<span class="cm">        });</span>
<span class="cm">        </span>
<span class="cm">        $container.append($(elems));</span>

<span class="cm">        this.model.projectiles.add(projectiles);</span>
<span class="cm">    },*/</span>

    <span class="nx">renderKillStats</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.kill-stats&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

        <span class="nx">_</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">killStats</span><span class="p">).</span><span class="nx">chain</span><span class="p">().</span><span class="nx">pairs</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">aSum</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">kills</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">deaths</span><span class="p">,</span>
                <span class="nx">bSum</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">kills</span><span class="o">-</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">deaths</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">bSum</span> <span class="o">&gt;</span> <span class="nx">aSum</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">bSum</span> <span class="o">&lt;</span> <span class="nx">aSum</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stats</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nx">elem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;li&gt;&lt;/li&gt;&quot;</span><span class="p">);</span>
                <span class="nx">stats</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">elem</span><span class="p">.</span><span class="nx">text</span><span class="p">((</span><span class="nx">stats</span><span class="p">.</span><span class="nx">kills</span><span class="o">-</span><span class="nx">stats</span><span class="p">.</span><span class="nx">deaths</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; (&quot;</span><span class="o">+</span><span class="nx">stats</span><span class="p">.</span><span class="nx">kills</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="nx">stats</span><span class="p">.</span><span class="nx">deaths</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">color</span> <span class="p">});</span>


            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.kill-stats&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">resizeViewport</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">||</span> <span class="mi">1800</span><span class="p">;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">||</span> <span class="mi">800</span><span class="p">;</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span>
            <span class="nx">width</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span>
            <span class="nx">height</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">backdrop</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#backdrop&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">backdrop</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">;</span>
        <span class="nx">backdrop</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">overlay</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#overlay&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">overlay</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">;</span>
        <span class="nx">overlay</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Implementation from http://rosettacode.org/wiki/Averages/Simple<em>moving</em>average#JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">SimpleMovingAverager</span><span class="p">(</span><span class="nx">period</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">nums</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">num</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">period</span><span class="p">)</span>
            <span class="nx">nums</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// remove the first element of the array</span>
        <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">nums</span><span class="p">)</span>
            <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">period</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">period</span><span class="p">)</span>
            <span class="nx">n</span> <span class="o">=</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">return</span><span class="p">(</span><span class="nx">sum</span><span class="o">/</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">frameRateAverager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleMovingAverager</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="nx">framesSeen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">lastSecond</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">frameRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">lastAnimationTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">baseTickLength</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">tickLength</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseTickLength</span><span class="p">;</span>

<span class="k">this</span><span class="p">.</span><span class="nx">tickPhase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">tickPhaseLength</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="k">this</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span> <span class="nx">tick</span> <span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">time</span><span class="p">){</span>
        <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">tickLength</span> <span class="o">=</span> <span class="nx">time</span> <span class="o">-</span> <span class="nx">app</span><span class="p">.</span><span class="nx">lastAnimationTime</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>The overlay layer should not persist,
so we have to clear it every frame.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">overlayCtx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>This is above the entity loops so the player
can fire his own weapons before autoFire kicks in.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">mousedown</span><span class="p">)</span> <span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">firePlayerControlled</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">entitiesLength</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">size</span><span class="p">(),</span>
        <span class="nx">projsLength</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">projectiles</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>The hot loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">entity</span><span class="p">.</span><span class="nx">tick</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">entitiesLength</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">projectiles</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">proj</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">proj</span><span class="p">.</span><span class="nx">tick</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">projsLength</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">sortEntities</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Fade out the backdrop layer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="o">=</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">globalAlpha</span><span class="o">=</span><span class="mf">0.02</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span><span class="nx">app</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">backdropCtx</span><span class="p">.</span><span class="nx">globalAlpha</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">lastAnimationTime</span> <span class="o">=</span> <span class="nx">time</span> <span class="o">||</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">lastSecond</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastSecond</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastAnimationTime</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">framesSeen</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastAnimationTime</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastSecond</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">frameRate</span> <span class="o">=</span> <span class="nx">frameRateAverager</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">framesSeen</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">framesSeen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastSecond</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">tickPhase</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tickPhase</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickPhaseLength</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">tickPhase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recordTiming</span><span class="p">)</span> <span class="nb">window</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">);</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">tick</span><span class="p">);</span>
<span class="p">},</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Utility function for playing
with the entities via the console.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">this</span><span class="p">.</span><span class="nx">updateAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">){</span> <span class="nx">it</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">});</span>
<span class="p">};</span>

<span class="k">this</span><span class="p">.</span><span class="nx">getEntDist</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ent</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ent</span><span class="p">.</span><span class="nx">cid</span> <span class="o">===</span> <span class="nx">a</span><span class="p">;</span> <span class="p">}).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">).</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ent</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ent</span><span class="p">.</span><span class="nx">cid</span> <span class="o">===</span> <span class="nx">b</span><span class="p">;</span> <span class="p">}).</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">));</span>
<span class="p">};</span>

<span class="k">this</span><span class="p">.</span><span class="nx">startup</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">();</span>

    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="s2">&quot;.fullscreen&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">launchFullScreen</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>The first tick doesn't receive a time.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startup</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">resizeViewport</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">(),</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">());</span>
<span class="p">});</span>

<span class="k">this</span><span class="p">.</span><span class="nx">launchFullScreen</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">launchFullScreen</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">requestFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">requestFullScreen</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">mozRequestFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">mozRequestFullScreen</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">webkitRequestFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">webkitRequestFullScreen</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">this</span><span class="p">.</span><span class="nx">cancelFullscreen</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">cancelFullscreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cancelFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cancelFullScreen</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">mozCancelFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">mozCancelFullScreen</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">webkitCancelFullScreen</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">webkitCancelFullScreen</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">this</span><span class="p">.</span><span class="nx">toggleFullscreen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">fullscreenEnabled</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">mozFullscreenEnabled</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">webkitFullscreenEnabled</span><span class="p">){</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">cancelFullscreen</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">launchFullScreen</span><span class="p">(</span><span class="nx">element</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>End namespace setup</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 